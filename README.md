# Υλοποίηση Συστημάτων Βάσεων Δεδομένων
# Εργασία 2

## Προσωπικά Στοιχεία

Όνομα: Tsvetomir Ivanov Α.Μ.: 1115201900066

Όνομα: Χρήστος Γαλανόπουλος Α.Μ.: 1115201900031

## Documentation

## 1. Δομη Project και οδηγίες εκτέλεσης
...

  Προσθήκη ενιαίου αρχείου επικεφαλίδας (header file):
- ht.h: Περιέχει τις κοινές δομές (Record, HF_Info:πίνακας ανοικτών αρχείων),  για πρωτεύον και δευτερεύον ευρετήριο.

## 2. Σχεδιαστικές επιλογές και παραδοχές

Ένα αρχείο δευτερεύοντος ευρετηρίου επεκτατού κατακερματισμού (SHT) περιέχει:

- 1 metadata block
- 1 ή παραπάνω hash blocks
- 2 ή παραπάνω data blocks

### a) Δομή metadata block

Ένα metadata block έχει την ακόλουθει δομή: 

- αναγνωρισιτκό του hash file -> 'HashFile'
- χαρακτήρας που καθορίζει σε ποιο πεδίο κλειδί δημιουργείται το δευτερεύον -> 'c' για city, 's' για surname
- τρέχον global depth
- αριθμός hash blocks
- id για το 1ο hash block
- id για το 2ο hash block
- ...

### b) Δομή hash block

Ένα hash block έχει την ακόλουθει δομή:

- bucket 0 που περιέχει ένα data block id
- bucket 1 που περιέχει ένα data block id
- ...

### c) Δομή data block

Ενα data block έχει την ακόλουθη δομή:

- τρέχον local depth
- αριθμός εγγραφών
- 1η εγγραφή
- 2η εγγραφή
- ...

Ο αριθμός των εγγραφών που χωράνε στο data block είναι δίνεται απο την σταθερά SECONDARY_BLOCK_CAP = 512-4/24 = 21 εγγραφές (24 ειναι το μέγεθος της δομης Secondary Record).

### Secondary Hash Table
Οπως και με το πρωτεύον ευρετήριο, το hash table είναι νοητό, εννοώντας ότι δεν υπάρχει κάποιο struct για την αναπαράστασή του αλλά συνίσταται από όλα τα hash blocks που περιέχουν τα buckets.

### Hash_Function
Το hash function δέχεται ως όρισμα το index-key μιας εγγραφής και κάνει καποιες κατάλληλες για συμοβολοσειρές ενέργειες κατακερματισμού επιστρέφοντας ενα string απο 14 χαρακτήρες ('0' και '1').
  
### HF_Info open_files: Πίνακας ανοικτών αρχείων
Χρησιμοποιείται ένας πίνακας χωρητικότητας 20, για αποθήκευση οποιονδήποτε ανοιχτών αρχείων, είτε ειναι πρωτευοντα ευρετήρια είτε δευτερεύοντα. Εχουν προστεθεί κάποια extra πεδία στο struct HF_Info:

- file descriptor
- τρέχον βάθος
- αριθμός εισαχθέντων εγγραφών
- τρέχον αριθμός κάδων
- τρέχον αριθμός hash blocks
- ονομα του αρχείου
- τύπος ευρετηρίου (πρωτεύον ή δευτερεύον)
- θεση στον πίνακα των ανοικτών αρχείων του αντίστοιχου αρχειου πρωτεύοντος ευρετηρίου πάνω στο οποίο εχει δημιουργηθεί ενα δευτερεύον
- τυπος κλειδιού (index-key) στην περίπτωση που ειναι δευτερεύον -> ('c' για city, 's' για surname)
- split -> χρησιμοποιείται για τον χειρισμό των split που μπορεί να προκύψουν σε ενα πρωτεύον ευρετήριο επηρεάζοντας ανάλογα το δευτερεύον

## 3. Ανάλυση λειτουργικότητας HT, SHT συναρτήσεων
 
### HT_Init, SHT_Init:
Επειδή η HT_Init αρχικοποιεί τον αδειο πίνακα open_files, η SHT_Init δεν χρειάζεται να κάνει καποια λειτουρία.

###  HT_InsertEntry(int indexDesc, Record record, int *tupleId, UpdateRecordArray** updateArray, int* updateArraySize):

Το πρότυπο της συνάρτησης εισαγωγής εγγραφής στο πρωτεύον ευρετήριο εχει τροποποιηθεί ως εξης:
- αλλαγή του δεικτη σε δομη UpdateRecordArray σε διπλό, ώστε να ειναι δυνατή η τροποποιηση του πίνακα των δομων αυτών απο την συνάρτηση και η επιστροφή του στην συνάρτηση που την καλεί.
- προσθήκη δείκτη σε ακεραιο που δηλώνει το μέγεθος του πίνακα updateArray, καθώς αυτος δημιουργείται δυναμικά με malloc στην HT_InsertEntry και πρέπει να είναι γνωστός.

#### Τροποποίηση λειτουργίας:
Η HT_InsertEntry κάνει τις κατάλληλες ενέργειες ώστε να επιστρέψει την θέση στην οποία εισήχθη μια νέα εγγραφή, και να φτιάξει σε περίπτωση split τον πίνακα updateArray ο οποίος αποθηκεύει τις εγγραφές που άλλαξαν μετά την διάσπαση των bucket.

### SHT_CreateSecondaryIndex:
Δημιουργεί ένα νέο αρχείο επεκτατού κατακερματισμού δευτερεύοντος ευρετηρίου με δοσμένο βάθος, πεδίο κλειδί πάνω στο οποίο θα γίνει η ευρετηρίαση, και όνομα του αντίστοιχου αρχείου πρωτεύοντος ευρετηρίου. Η υλοποίηση της είναι παρόμοια με αυτήν της κατασκευής του πρωτεύοντος,  με την μόνη διαφορά την προσθήκη της πληροφορίας για το πεδίο κλειδι στο metadata του αρχείου.

### SHT_OpenSecondaryIndex:
Ελέγχεται ότι το αρχείο προς άνοιγμα είναι ένα valid hash file με ορθό index-key, ενημερώνεται κατάλληλα ο πίνακας open_files ώστε να περιέχει τις πληροφορίες που χρειάζονται και επιστρέφεται η θέση του πίνακα στην οποία αποθηκεύτηκαν.

#### Σχόλιο: Επειδή ο πίνακας των ανοικτών αρχείων είναι global και επομένως γνωστός και στην main συνάρτηση, επιλέγεται η τελευταία να ενημερώσει όταν φτιαχτεί και ανοιχτεί το δευτερεύον, το πεδίο που δηλώνει την θέση του αντιστοιχου πρωτεύοντος αρχείου. Η παραδοχή αυτή γίνεται για να μην επιβαρύνεται με παραπάνω πληροφορίες το metadata block του δευτερεύοντος.

### SHT_CloseSecondaryIndex:
Κλείνει το ανοιχτό δευτερεύον hash file και ενημερώνεται με κατάλληλο τρόπο ο πίνακας open_files.
