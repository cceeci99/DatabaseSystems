# Προσωπικά στοιχεία

__Όνομα__: Χρήστος Γαλανόπουλος __Α.Μ.__: 1115201900031

__Όνομα__: Tsvetomir Ivanov __Α.Μ.__: 1115201900066

## Documentation

Το documentation της εργασίας χωρίζεται σε τρία μέρη:

1. Δομή project και οδηγίες εκτέλεσης
2. Σχεδιαστικές επιλογές και παραδοχές
3. Ανάλυση λειτουργικότητας κάθε HT συνάρτησης  

## 1. Δομή project και οδηγίες εκτέλεσης

Τo project περιέχεται στο φάκελο code. Πέραν των αρχικών φακέλων έχει προστεθεί ένας ακόμη με όνομα files. Ο files περιέχει δύο υποφακέλους τον hash_files και τον logs, όπου στον πρώτο αποθηκεύονται τα παραγόμενα *.db αρχεία και στον logs  τα αποτελέσματα εκτύπωσης του προγράμματος. Όσον αφορά την εκτέλεση του προγράμματος το Makefile περιέχει αρκετές επιλογές:

- *make ht* για να γίνει το compilation ht_main.c σε συνδυασμό με τα υπόλοιπα αρχεία
- *make run* για εκτέλεση του build/runner με τα αντίστοιχα ορίσματα
- *make time* για εκτέλεση με build/runner χρονομέτρηση
- *make clean* για διαγραφή των παραγόμενων αρχείων
- *make all* εκτέλεση του run.sh για το οποίο ακολουθεί αναλυτική περιγραφή

run.sh : το script αυτό παράγει τα logs του build/runner εκτελώντας το για 10,100,500 και 1000 εγγραφές σε συνδυασμό με κάθε αρχικό βάθος από 1 έως 13. Στη συνέχεια ελέγχει για κάθε περίπτωση αριθμού εγγραφών (10,100,500,1000) αν έχει επιστραφεί το αναμενόμενο αποτέλεσμα, δηλαδή αν βρέθηε ίδιος αριθμός εγγραφών με αυτόν που εισήχθει.

**Όλες οι εντολές make πρέπει να εκτελεστούν από το φάκελο code.**

## 2. Σχεδιαστικές επιλογές και παραδοχές

Ένα hash file περιέχει:

- 1 metadata block
- 1 ή παραπάνω hash blocks
- 2 ή παραπάνω data blocks

### a) Δομή metadata block

Ένα metadata block έχει την ακόλουθει δομή:

- αναγνωρισιτκό του hash file -> `'HashFile'`
- τρέχον global depth
- αριθμός hash blocks
- id για το 1ο hash block
- id για το 2ο hash block
- ...

### b) Δομή hash block

Ένα hash block έχει την ακόλουθει δομή:

- bucket 0 που περιέχει ένα data block id
- bucket 1 που περιέχει ένα data block id
- ...

### c) Δομή data block

Ένα data block έχει την ακόλουθει δομή:

- τρέχον local depth
- αριθμός εγγραφών
- 1η εγγραφή
- 2η εγγραφή
- ...

### Hash table

Το hash table είναι νοητό, εννοώντας ότι δεν υπάρχει κάποιο struct για την αναπαράστασή του αλλά συνίσταται από όλα τα hash blocks που περιέχουν τα buckets.

### Hash function

Το hash function δέχεται ως όρισμα το id του record και το τρέχον depth, κάνει κάποιες ενέργειες και στο τέλος επιστρέφει ένα string 14 χαρακτήρων (αφού έχουμε max_depth=13 και στο τέλος το '\0') από 0 και 1.

### Πίνακας open_files

Ο πίνακας open_files χρησιμοποιείται για την αποθήκευση πληροφοριών των ανοιχτών hash files. Έχει χωρητικότητα 20 και αποθηκεύει δομές τύπου HF_INFO. Μία δομή HF_INFO περιέχει τα ακόλουθα στοιχεία του αντίστοιχου ανοιχτού hash file:

- file descriptor
- τρέχον βάθος
- αριθμός εισαχθέντων εγγραφών
- τρέχον αριθμός bucket
- τρέχον αριθμός hash blocks
- όνομα του αρχείου

### Παραδοχές

1. Κάθε bucket "δείχνει" σε ένα data block
2. Τα ids είναι μη αρνητικά
3. Αρχικό depth > 0
4. Τα ids ακολουθούν ομοιόμορφη κατανομή, όχι περιπτώσεις με αλυσίδες υπερχείλισης
5. Μέγιστος αριθμός depth=13 για block_size=512. Επεξήγηση: ένα metadata block μπορεί να αποθηκεύσει τα ids από (512 - 17)/4=123 hash blocks και για depth=14 έχουμε (2^14)/128=128 hash blocks όπου το πρώτο 128 είναι ο αριθμός bucket χωράει ένα hash block

**Άρα για block_size=512 ισχύει 0 < depth < 14.**

## 3. Ανάλυση λειτουργικότητας κάθε HT συνάρτησης

### HT_Init

Aρχικοποιεί τον πίνακα open_files.

### HT_CreateIndex

Δημιουργεί ένα νέο hash file με το δοσμένο όνομα και βάθος. Ανάλογα με το μέγεθος του βάθους δημιουργείται αντίστοιχος αριθμός hash blocks, που θα περιέχουν τα buckets. Επίσης για κάθε bucket γίνεται preallocate ένα data block, καθώς σε αυτό το στάδιο δεν γίνεται να υπάρχουν φιλαράκια. Τέλος όλα τα παραγόμενα block αρχικοποιούνται κατάλληλα ανάλογα τον τύπο τους (metadata, hash, data).

### HT_OpenIndex

Ελέγχεται ότι το αρχείο προς άνοιγμα είναι ένα valid hash file, ενημερώνεται κατάλληλα ο πίνακας open_files ώστε να περιέχει τις πληροφορίες που χρειάζονται και επιστρέφεται η θέση του πίνακα στην οποία αποθηκεύτηκαν.

### HT_CloseFile

Κλείνει το ανοιχτό hash file και ενημερώνεται με κατάλληλο τρόπο ο πίνακας open_files.

### HT_InsertEntry

Στην εισαγωγή εγγραφής σε hash file διακρίνουμε περιπτώσεις:

- η εγγραφή χωράει στο data block στο οποίο έχει αντιστοιχηθεί
- η εγγραφή δεν χωράει στο data block στο οποίο έχει αντιστοιχηθεί

#### Πρώτη περίπτωση

Απλή τοποθέτηση της εγγραφής στο data block και ενημέρωση των πληροφοριών των block όπου χρειάζεται.

#### Δεύτερη περίπτωση

- Αν local_depth = global_depth -> αύξηση του depth κατά ένα και διπλασιασμός των buckets
  - Αν ο νέος αριθμός bucket δεν χωράει στα υπάρχοντα hash blocks -> δημιουργία όσον hash blocks απαιτούνται για να χωρέσουν (note: max_depth=13)
- Έπειτα συνεχίζουμε κανονικά στην περίπτωση local_depth < global_depth

### HT_PrintAllEntries

Εκτύπωση όλων των εγγραφών ή της εγγραφής με το δοσμένο id - εφόσον αυτή υπάρχει. Στην περίπτωση εκτύπωσης όλων των εγγραφών, στο τέλος εκτυπώνεται και το συνολικό πλήθος εγγραφών που βρέθηκαν το οποίο πρέπει να είναι ίσο με το αντίστοιχο πλήθος αυτών που εισήχθησαν.

### HashStatistics

Εκτύπωση για κάθε hash block του αρχείου:

- του ελάχιστου αριθμού εγγραφών
- του μέσου αριθμού εγγραφών
- του μέγιστου αριθμού εγγραφών

Οι αριθμοί αυτοί αφορούν τα data blocks στα οποία "δείχνουν" τα buckets του εκάστοτε hash block.

**Γενική παρατήρηση: στα αρχεία κώδικα υπάρχουν αναλυτικά σχόλια όσον αφορά την υλοποίηση κάθε συνάρτησης.**
